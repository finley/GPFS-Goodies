#!/bin/bash

#
# StanzaFile-creator
#

#
#   2014.05.23 Brian Elliott Finley <bfinley@us.ibm.com>
#   - Created for demo at Edge2014
#   2014.07.01 Brian Elliott Finley <bfinley@us.ibm.com>
#   - Improved help output and options validation
#   2014.07.09 Brian Elliott Finley <bfinley@us.ibm.com> & Lerone Latouche <latouche@us.ibm.com>
#   - Identified and fixed bug where remote commands were not properly
#     escaped
#

server1=$1
server2=$2

PROGNAME=$(basename $0)

if [ -z $server2 ]; then
    echo "
Usage: $PROGNAME SERVER1 SERVER2

    Where SERVER1 and SERVER2 are the node names for your two NSD
    servers as they appear in the 'Admin node name' column in the
    'mmlscluster' output.


    Details:

    This script will auto-create a GPFS StanzaFile (written to STDOUT)
    that should be considered an example of how you can appropriately
    balance your disk devices across your NSD servers for best
    performance.  
    
    It may be used as-is in many cases.

    You'll want to re-direct the output to a file for use with the
    mmcrnsd command:

        $PROGNAME SERVER1 SERVER2 > SERVER1-SERVER2.StanzaFile
    
    WARNING:  This script should work as-is for a GPFS building block
    that:

        a) includes two NSD servers
        b) that are both multipathed to the same storage subsystem
        c) that have been prepared for use with the GPFS Goodies
           multipath.conf-creator tool.

    Please review your StanzaFile for appropriateness before using, and
    you may need to modify this script or use an alternate method for
    use with different building block configurations.

    If you are satisfied with the StanzaFile you've created, you can use
    mmcrnsd to initialize the disks (see "man mmcrnsd" for more details):

        mmcrnsd -F SERVER1-SERVER2.StanzaFile


    Have fun!  -Brian Finley

"
    exit 1
fi


CONTROLLER_REGEX='[ab]_lun[0-9]+'

count=1
for lun in $(ssh $server1 ls -1 /dev/mapper/* | egrep $CONTROLLER_REGEX | awk -F'lun' '{print $2" "$1"lun"$2}' | sort -n | awk '{print $NF}')
do 
	NsdName=$(basename $lun)
	if [ $count -le 2 ]; then
		servers=$server1,$server2
	else
		servers=$server2,$server1
	fi
	echo %nsd: device=$lun  nsd=$NsdName  servers=$servers

	if [ $count -eq 4 ]; then
		count=1
	else
		count=$(( $count + 1 ))
	fi
done



